'use strict';

/** @type {import('sequelize-cli').Migration} */
module.exports = {
  async up(queryInterface, Sequelize) {
    await queryInterface.createTable('payment_records', {
      id: {
        allowNull: false,
        autoIncrement: true,
        primaryKey: true,
        type: Sequelize.INTEGER,
      },
      
      // Foreign keys
      user_id: {
        type: Sequelize.INTEGER,
        allowNull: false,
        references: {
          model: 'users',
          key: 'id',
        },
        onDelete: 'CASCADE',
      },
      tournament_id: {
        type: Sequelize.INTEGER,
        allowNull: true,
        references: {
          model: 'tournaments',
          key: 'id',
        },
        onDelete: 'CASCADE',
      },
      transaction_id: {
        type: Sequelize.INTEGER,
        allowNull: true,
        references: {
          model: 'transactions',
          key: 'id',
        },
        onDelete: 'CASCADE',
      },
      
      // Reference IDs
      order_reference: {
        type: Sequelize.STRING(100),
        allowNull: false,
        unique: true,
        comment: 'Unique order reference generated by system',
      },
      payment_reference: {
        type: Sequelize.STRING(255),
        allowNull: true,
        comment: 'Payment provider transaction ID (ClickPesa)',
      },
      
      // Payment details
      amount: {
        type: Sequelize.DECIMAL(12, 2),
        allowNull: false,
        validate: {
          min: 0,
        },
      },
      currency: {
        type: Sequelize.STRING(3),
        allowNull: false,
        defaultValue: 'TZS',
      },
      payment_method: {
        type: Sequelize.STRING(50),
        allowNull: false,
        defaultValue: 'mobile_money_deposit',
        validate: {
          isIn: [['mobile_money_deposit', 'bank_payout', 'mobile_money_entry']],
        },
      },
      
      // Customer information
      customer_phone: {
        type: Sequelize.STRING(20),
        allowNull: true,
        comment: 'Formatted phone number (255XXXXXXXXX)',
      },
      customer_email: {
        type: Sequelize.STRING(255),
        allowNull: true,
      },
      
      // Payment status
      status: {
        type: Sequelize.STRING(50),
        allowNull: false,
        defaultValue: 'initiated',
        validate: {
          isIn: [['initiated', 'pending', 'processing', 'successful', 'failed', 'cancelled', 'expired', 'refunded', 'reversed']],
        },
      },
      
      // Fee information
      transaction_fee: {
        type: Sequelize.DECIMAL(10, 2),
        allowNull: true,
        defaultValue: 0,
      },
      net_amount: {
        type: Sequelize.DECIMAL(12, 2),
        allowNull: true,
        comment: 'Amount after fees (amount - transaction_fee)',
      },
      
      // ClickPesa fields
      clickpesa_payment_id: {
        type: Sequelize.STRING(255),
        allowNull: true,
      },
      checkout_id: {
        type: Sequelize.STRING(255),
        allowNull: true,
      },
      
      // Channel information
      channel: {
        type: Sequelize.STRING(50),
        allowNull: true,
        comment: 'Payment channel (e.g., TIGO-PESA, AIRTEL-MONEY)',
      },
      channel_provider: {
        type: Sequelize.STRING(100),
        allowNull: true,
      },
      
      // Response data
      gateway_response: {
        type: Sequelize.JSON,
        allowNull: true,
        comment: 'Initial gateway response',
      },
      webhook_data: {
        type: Sequelize.JSON,
        allowNull: true,
        comment: 'Webhook payload from payment provider',
      },
      metadata: {
        type: Sequelize.JSON,
        allowNull: true,
        comment: 'Additional payment information',
      },
      
      // Timestamps for tracking
      initiated_at: {
        type: Sequelize.DATE,
        allowNull: true,
      },
      completed_at: {
        type: Sequelize.DATE,
        allowNull: true,
      },
      cancelled_at: {
        type: Sequelize.DATE,
        allowNull: true,
      },
      failed_at: {
        type: Sequelize.DATE,
        allowNull: true,
      },
      
      // Webhook processing
      webhook_processed: {
        type: Sequelize.BOOLEAN,
        defaultValue: false,
      },
      webhook_processed_at: {
        type: Sequelize.DATE,
        allowNull: true,
      },
      
      // Audit fields
      created_by_ip: {
        type: Sequelize.STRING(45),
        allowNull: true,
      },
      updated_by_ip: {
        type: Sequelize.STRING(45),
        allowNull: true,
      },
      
      // Timestamps
      created_at: {
        type: Sequelize.DATE,
        allowNull: false,
        defaultValue: Sequelize.literal('NOW()'),
      },
      updated_at: {
        type: Sequelize.DATE,
        allowNull: false,
        defaultValue: Sequelize.literal('NOW()'),
      },
    });

    // Create indexes
    await queryInterface.addIndex('payment_records', ['order_reference'], {
      name: 'idx_payment_records_order_ref',
      unique: true,
    });
    
    await queryInterface.addIndex('payment_records', ['user_id'], {
      name: 'idx_payment_records_user',
    });
    
    await queryInterface.addIndex('payment_records', ['status'], {
      name: 'idx_payment_records_status',
    });
    
    await queryInterface.addIndex('payment_records', ['payment_method'], {
      name: 'idx_payment_records_method',
    });
    
    await queryInterface.addIndex('payment_records', ['created_at'], {
      name: 'idx_payment_records_created',
    });
    
    await queryInterface.addIndex('payment_records', ['user_id', 'status'], {
      name: 'idx_payment_records_user_status',
    });
    
    await queryInterface.addIndex('payment_records', ['payment_reference'], {
      name: 'idx_payment_records_payment_ref',
    });
    
    await queryInterface.addIndex('payment_records', ['customer_phone'], {
      name: 'idx_payment_records_customer_phone',
    });
    
    await queryInterface.addIndex('payment_records', ['tournament_id'], {
      name: 'idx_payment_records_tournament',
    });
  },

  async down(queryInterface, Sequelize) {
    // Remove indexes first
    await queryInterface.removeIndex('payment_records', 'idx_payment_records_order_ref');
    await queryInterface.removeIndex('payment_records', 'idx_payment_records_user');
    await queryInterface.removeIndex('payment_records', 'idx_payment_records_status');
    await queryInterface.removeIndex('payment_records', 'idx_payment_records_method');
    await queryInterface.removeIndex('payment_records', 'idx_payment_records_created');
    await queryInterface.removeIndex('payment_records', 'idx_payment_records_user_status');
    await queryInterface.removeIndex('payment_records', 'idx_payment_records_payment_ref');
    await queryInterface.removeIndex('payment_records', 'idx_payment_records_customer_phone');
    await queryInterface.removeIndex('payment_records', 'idx_payment_records_tournament');
    
    // Drop table
    await queryInterface.dropTable('payment_records');
  }
};